# Multi-stage Dockerfile for TVBOOT IPTV Platform
FROM openjdk:21-jdk-slim as builder

WORKDIR /app
  
  # Copy Maven files for dependency resolution
COPY pom.xml .
COPY .mvn .mvn
COPY mvnw .
  
  # Make mvnw executable
RUN chmod +x mvnw
  
  # Download dependencies
RUN ./mvnw dependency:go-offline -B
  
  # Copy source code
COPY src ./src
  
  # Build the application
RUN ./mvnw clean package -DskipTests
  
  # Production stage
FROM openjdk:21-jre-slim
  
  # Set environment variables
ENV SPRING_PROFILES_ACTIVE=prod
ENV JAVA_OPTS="-Xmx1g -Xms512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
  
  # Create app user for security
RUN groupadd -r tvboot && useradd -r -g tvboot tvboot
  
  # Create necessary directories
RUN mkdir -p /app/uploads/logos/channels && \
mkdir -p /app/logs && \
chown -R tvboot:tvboot /app

WORKDIR /app
  
  # Copy the built JAR from builder stage
COPY --from=builder /app/target/tivio-*.jar app.jar
  
  # Change ownership to app user
RUN chown tvboot:tvboot app.jar
  
  # Switch to non-root user
USER tvboot
  
  # Expose port
EXPOSE 8080
  
  # Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
CMD curl -f http://localhost:8080/actuator/health || exit 1
  
  # Start the application
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]